name: Prefetch Team Shots

on:
  schedule:
    # 9:00 AM America/Chicago (CST=UTC-6 in Jan). If you switch to daylight time later, adjust.
    - cron: "0 15 * * *"
  workflow_dispatch:

jobs:
  prefetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    if [ -f requirements.txt ]; then
      pip install -r requirements.txt
    else
      pip install requests pyyaml
    fi

      - name: Debug repo root
        run: |
          pwd
          ls -la

      - name: Compile-check script
        run: python -m py_compile prefetch_teamshots_today.py


      - name: Run prefetch (never fail the workflow)
        shell: bash
        run: |
          set +e
          python prefetch_teamshots_today.py
          code=$?
          echo "prefetch exit code: $code"
          # Never fail the job due to upstream API/DNS
          exit 0

      - name: Ensure cache file exists
        shell: bash
        run: |
          mkdir -p data/cache
          if [ ! -f data/cache/teamshots_today.json ]; then
            echo "{}" > data/cache/teamshots_today.json
          fi
          echo "Cache file contents:"
          cat data/cache/teamshots_today.json || true

      - name: Commit cache
        shell: bash
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/cache/teamshots_today.json
          git commit -m "Update team shots cache" || echo "No changes to commit"
          git push
